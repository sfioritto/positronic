#!/usr/bin/env node
/**
 * Post-build script that reads the bundled components.js and generates
 * a TypeScript file that exports the bundle content as a string literal.
 * This avoids filesystem access at runtime, which is required for
 * Cloudflare Workers compatibility.
 */

import { readFileSync, writeFileSync } from 'node:fs';
import { join, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const bundlePath = join(__dirname, '..', 'dist', 'components.js');
const outputPath = join(__dirname, '..', 'src', 'generated-bundle.ts');

// Read the bundle content
const bundleContent = readFileSync(bundlePath, 'utf-8');

// Escape backticks and ${} for template literal
const escapedContent = bundleContent
  .replace(/\\/g, '\\\\')
  .replace(/`/g, '\\`')
  .replace(/\$\{/g, '\\${');

// Generate the TypeScript file
const output = `// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by scripts/generate-bundle-export.js

/**
 * Pre-bundled JavaScript for client-side component rendering.
 * This is the content of dist/components.js inlined as a string.
 */
export const componentBundle = \`${escapedContent}\`;
`;

writeFileSync(outputPath, output, 'utf-8');
console.log('Generated src/generated-bundle.ts');
